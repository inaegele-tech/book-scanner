<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book Scanner</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { 
            margin: 0; 
            font-family: sans-serif; 
            background: black; 
            color: white; 
            text-align: center; 
        }
        video { 
            width: 100%; 
            max-height: 70vh; 
            background: #222; 
            display: block;
        }
        #videoContainer {
            position: relative;
            max-height: 70vh;
            overflow: hidden;
        }
        #overlay { 
            position: absolute; 
            top: 35%; 
            left: 10%; 
            width: 80%; 
            height: 18%; 
            border: 4px solid lime; 
            border-radius: 12px; 
            pointer-events: none; 
            z-index: 10; 
            transition: border-color 0.3s;
        }
        #status { 
            padding: 15px; 
            font-size: 16px; 
            font-weight: bold; 
            background: #333; 
            min-height: 30px;
            word-wrap: break-word;
        }
        .status-error { background: #c0392b !important; }
        .status-success { background: #27ae60 !important; }
        
        button { 
            margin: 5px; 
            padding: 12px 20px; 
            font-size: 16px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.7; }
        
        .btn-office { background: #3498db; color: white; }
        .btn-living { background: #e67e22; color: white; }
        .btn-storage { background: #95a5a6; color: white; }
        .btn-active { box-shadow: 0 0 0 3px yellow; }
        
        #scanHistory { 
            margin: 20px auto; 
            max-width: 600px; 
            text-align: left; 
            padding: 10px;
            font-size: 14px;
        }
        .history-item { 
            padding: 8px; 
            background: #222; 
            margin: 5px 0; 
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }
        .history-item.error { border-left-color: #c0392b; }
        
        #controls { margin: 15px 0; }
        
        #debugInfo {
            font-size: 12px;
            color: #888;
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
            display: none;
        }
    </style>
</head>
<body>

<h3>ISBN Scanner</h3>

<div id="videoContainer">
    <video id="video" autoplay playsinline muted></video>
    <div id="overlay"></div>
</div>

<div id="status">Initializing...</div>

<div id="controls">
    <div style="margin-bottom: 10px;">
        <button class="btn-office btn-active" onclick="setShelf('Office')">Office</button>
        <button class="btn-living" onclick="setShelf('Living Room')">Living Room</button>
        <button class="btn-storage" onclick="setShelf('Storage')">Storage</button>
    </div>
    <div>
        <button style="background: #e74c3c; color: white;" onclick="restartCamera()">Restart Camera</button>
        <button style="background: #16a085; color: white;" onclick="clearHistory()">Clear History</button>
        <button style="background: #7f8c8d; color: white;" onclick="toggleDebug()">Debug Info</button>
    </div>
</div>

<div id="debugInfo"></div>
<div id="scanHistory"></div>

<script>
    // ===== CONFIGURATION =====
    const sheetURL = "https://script.google.com/macros/s/AKfycbzXcOENqBVMGownK_xyoQZxKQeaXsho142gUoV9sfrz9jJNWWHT9Cy_UlKAzcHXRPsq/exec";
    const SCAN_DELAY = 2500;
    const MAX_HISTORY = 20;
    const CAMERA_TIMEOUT = 10000; // 10 second timeout
    
    // ===== STATE =====
    let codeReader;
    let scanControls;
    let lastScanTime = 0;
    let lastScan = "";
    let currentShelf = "Office";
    let isScanning = true;
    let scanHistory = [];
    let cameraStartTime = 0;
    let debugMode = false;

    // ===== INITIALIZATION =====
    window.addEventListener('load', function() {
        addDebug("Page loaded");
        
        // Check for ZXing library
        if (typeof ZXing === 'undefined') {
            showError("ZXing library failed to load. Check internet connection.");
            addDebug("ERROR: ZXing not loaded");
            return;
        }
        
        try {
            codeReader = new ZXing.BrowserMultiFormatReader();
            addDebug("ZXing initialized: " + ZXing.BrowserMultiFormatReader.name);
            loadHistory();
            initCamera();
        } catch (e) {
            showError("Failed to initialize scanner: " + e.message);
            addDebug("ERROR: " + e.toString());
        }
    });

    function initCamera() {
        addDebug("initCamera() called");
        const statusEl = document.getElementById('status');
        const videoEl = document.getElementById('video');
        
        cameraStartTime = Date.now();
        
        // Check for getUserMedia support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError("Camera not supported in this browser");
            addDebug("ERROR: getUserMedia not available");
            return;
        }
        
        statusEl.textContent = "Starting camera...";
        addDebug("Requesting camera permissions...");
        
        // Set timeout to catch stuck camera initialization
        const timeout = setTimeout(() => {
            if (statusEl.textContent === "Starting camera...") {
                showError("Camera timeout. Tap 'Restart Camera' to retry.");
                addDebug("ERROR: Camera initialization timeout after " + CAMERA_TIMEOUT + "ms");
            }
        }, CAMERA_TIMEOUT);
        
        // Get list of video devices
        codeReader.listVideoInputDevices()
            .then((videoDevices) => {
                clearTimeout(timeout);
                
                if (videoDevices.length === 0) {
                    showError("No camera found");
                    addDebug("ERROR: No video devices detected");
                    return;
                }
                
                addDebug("Found " + videoDevices.length + " camera(s)");
                videoDevices.forEach((device, i) => {
                    addDebug(`  Camera ${i}: ${device.label || 'Unknown'} [${device.deviceId.substr(0, 8)}...]`);
                });
                
                // Find back camera (prefer environment-facing)
                const backCam = videoDevices.find(device => 
                    /back|rear|environment/i.test(device.label)
                );
                const selectedDevice = backCam || videoDevices[0];
                
                addDebug("Selected camera: " + (selectedDevice.label || 'Default'));
                statusEl.textContent = "Starting scanner...";
                
                // Start decoding with hints for better performance
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.EAN_8,
                    ZXing.BarcodeFormat.UPC_A,
                    ZXing.BarcodeFormat.UPC_E
                ]);
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                
                return codeReader.decodeFromVideoDevice(
                    selectedDevice.deviceId, 
                    'video', 
                    (result, err) => {
                        if (result && isScanning) {
                            handleBarcode(result.text);
                        }
                        // Silently ignore NotFoundException (no barcode in frame)
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            addDebug("Decode error: " + err.toString());
                        }
                    },
                    hints
                );
            })
            .then((controls) => {
                if (controls) {
                    scanControls = controls;
                    const elapsed = Date.now() - cameraStartTime;
                    addDebug("Camera started successfully in " + elapsed + "ms");
                    statusEl.textContent = "Ready! Align barcode in the box...";
                    document.getElementById('overlay').style.borderColor = "lime";
                }
            })
            .catch(err => {
                clearTimeout(timeout);
                addDebug("Camera error: " + err.toString());
                console.error("Camera error:", err);
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    showError("Camera blocked. Grant permission in browser settings.");
                    addDebug("User denied camera permission");
                } else if (err.name === 'NotFoundError') {
                    showError("No camera found on this device");
                } else if (err.name === 'NotReadableError') {
                    showError("Camera in use by another app");
                } else if (err.name === 'OverconstrainedError') {
                    showError("Camera doesn't meet requirements");
                } else if (err.name === 'TypeError') {
                    showError("Camera initialization failed. Try restarting.");
                } else {
                    showError("Camera error: " + err.message);
                }
            });
    }

    function restartCamera() {
        addDebug("Restart camera button clicked");
        
        // Stop existing camera
        if (scanControls) {
            try {
                scanControls.stop();
                addDebug("Stopped existing camera");
            } catch (e) {
                addDebug("Error stopping camera: " + e.toString());
            }
        }
        
        // Reset video element
        const video = document.getElementById('video');
        video.srcObject = null;
        
        // Clear state
        scanControls = null;
        lastScan = "";
        lastScanTime = 0;
        
        // Reinitialize
        document.getElementById('status').textContent = "Restarting...";
        setTimeout(() => {
            initCamera();
        }, 500);
    }

    // ===== ISBN VALIDATION =====
    function isValidISBN(code) {
        const cleaned = code.replace(/[-\s]/g, '');
        const isbn10Pattern = /^\d{9}[\dX]$/;
        const isbn13Pattern = /^(978|979)\d{10}$/;
        return isbn10Pattern.test(cleaned) || isbn13Pattern.test(cleaned);
    }

    // ===== BARCODE HANDLING =====
    function handleBarcode(code) {
        const now = Date.now();
        
        if (code === lastScan && (now - lastScanTime) < SCAN_DELAY) {
            return;
        }

        lastScan = code;
        lastScanTime = now;

        addDebug("Scanned: " + code);

        if (!isValidISBN(code)) {
            showStatus(`Not an ISBN: ${code}`, 'error');
            flashOverlay('red');
            addDebug("Invalid ISBN format");
            return;
        }

        showStatus(`Scanning: ${code}...`, 'normal');
        flashOverlay('orange');
        
        if (navigator.vibrate) {
            navigator.vibrate(100);
        }

        uploadToSheet(code);
    }

    // ===== UPLOAD TO GOOGLE SHEETS =====
    function uploadToSheet(isbn) {
        const timestamp = new Date().toISOString();
        const uploadUrl = `${sheetURL}?isbn=${encodeURIComponent(isbn)}&shelf=${encodeURIComponent(currentShelf)}&timestamp=${encodeURIComponent(timestamp)}`;
        
        addDebug("Uploading to: " + uploadUrl.substring(0, 80) + "...");
        
        fetch(uploadUrl, { 
            mode: 'no-cors',
            method: 'GET'
        })
            .then(() => {
                showStatus(`✓ Saved ${isbn} to ${currentShelf}`, 'success');
                flashOverlay('lime');
                addToHistory(isbn, currentShelf, true);
                addDebug("Upload successful");
            })
            .catch(err => {
                console.error("Upload error:", err);
                showStatus(`✗ Upload failed for ${isbn}`, 'error');
                flashOverlay('red');
                addToHistory(isbn, currentShelf, false);
                addDebug("Upload failed: " + err.toString());
            });
    }

    // ===== UI HELPERS =====
    function showStatus(message, type = 'normal') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = type === 'error' ? 'status-error' : type === 'success' ? 'status-success' : '';
        
        if (type !== 'normal') {
            setTimeout(() => {
                if (statusEl.textContent === message) {
                    statusEl.textContent = "Ready! Align barcode in the box...";
                    statusEl.className = '';
                }
            }, 3000);
        }
    }

    function showError(message) {
        showStatus("ERROR: " + message, 'error');
    }

    function flashOverlay(color) {
        const overlay = document.getElementById('overlay');
        overlay.style.borderColor = color;
        setTimeout(() => {
            overlay.style.borderColor = 'lime';
        }, 1000);
    }

    // ===== SHELF MANAGEMENT =====
    function setShelf(name) {
        currentShelf = name;
        showStatus(`Shelf set to: ${name}`, 'normal');
        
        document.querySelectorAll('button[class*="btn-"]').forEach(btn => {
            btn.classList.remove('btn-active');
        });
        event.target.classList.add('btn-active');
        
        addDebug("Shelf changed to: " + name);
    }

    // ===== HISTORY MANAGEMENT =====
    function addToHistory(isbn, shelf, success) {
        const item = {
            isbn: isbn,
            shelf: shelf,
            success: success,
            timestamp: new Date().toLocaleTimeString()
        };
        
        scanHistory.unshift(item);
        
        if (scanHistory.length > MAX_HISTORY) {
            scanHistory = scanHistory.slice(0, MAX_HISTORY);
        }
        
        saveHistory();
        renderHistory();
    }

    function renderHistory() {
        const historyEl = document.getElementById('scanHistory');
        
        if (scanHistory.length === 0) {
            historyEl.innerHTML = '';
            return;
        }
        
        historyEl.innerHTML = '<strong>Recent Scans:</strong>' + 
            scanHistory.map(item => `
                <div class="history-item ${item.success ? '' : 'error'}">
                    ${item.success ? '✓' : '✗'} ${item.isbn} → ${item.shelf} 
                    <span style="float:right; opacity:0.6">${item.timestamp}</span>
                </div>
            `).join('');
    }

    function clearHistory() {
        if (confirm('Clear scan history?')) {
            scanHistory = [];
            saveHistory();
            renderHistory();
            showStatus('History cleared', 'normal');
            addDebug("History cleared");
        }
    }

    function saveHistory() {
        try {
            localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
        } catch (e) {
            addDebug("Failed to save history: " + e.toString());
        }
    }

    function loadHistory() {
        try {
            const saved = localStorage.getItem('scanHistory');
            if (saved) {
                scanHistory = JSON.parse(saved);
                renderHistory();
                addDebug("Loaded " + scanHistory.length + " history items");
            }
        } catch (e) {
            addDebug("Failed to load history: " + e.toString());
        }
    }

    // ===== DEBUG HELPERS =====
    function addDebug(message) {
        const timestamp = new Date().toLocaleTimeString();
        const debugEl = document.getElementById('debugInfo');
        const line = `[${timestamp}] ${message}\n`;
        debugEl.textContent = line + debugEl.textContent;
        console.log(line);
        
        // Keep only last 50 lines
        const lines = debugEl.textContent.split('\n');
        if (lines.length > 50) {
            debugEl.textContent = lines.slice(0, 50).join('\n');
        }
    }

    function toggleDebug() {
        debugMode = !debugMode;
        const debugEl = document.getElementById('debugInfo');
        debugEl.style.display = debugMode ? 'block' : 'none';
        event.target.textContent = debugMode ? 'Hide Debug' : 'Debug Info';
    }

    // ===== CLEANUP =====
    window.addEventListener('beforeunload', function() {
        if (scanControls) {
            try {
                scanControls.stop();
            } catch (e) {
                console.error("Error stopping camera:", e);
            }
        }
    });

    // Add visibility change handler to manage camera when tab is hidden
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            addDebug("Tab hidden, pausing scanner");
        } else {
            addDebug("Tab visible, resuming scanner");
        }
    });
</script>

</body>
</html>
