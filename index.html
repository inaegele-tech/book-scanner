<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book Scanner</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { margin:0; font-family:sans-serif; background:black; color:white; text-align:center; }
        video { width:100%; max-height: 70vh; background: #222; }
        #overlay { position:absolute; top:35%; left:10%; width:80%; height:18%; border:4px solid lime; border-radius:12px; pointer-events:none; z-index: 10; }
        #status { padding:15px; font-size:18px; font-weight: bold; background: #333; }
        button { margin:5px; padding:12px; font-size:16px; border-radius: 8px; border: none; cursor: pointer; }
        .btn-office { background: #3498db; color: white; }
        .btn-living { background: #e67e22; color: white; }
        .btn-storage { background: #95a5a6; color: white; }
    </style>
</head>
<body>

<h3>ISBN Scanner</h3>

<div style="position:relative;">
    <video id="video" autoplay playsinline muted></video>
    <div id="overlay"></div>
</div>

<div id="status">Initializing...</div>

<div style="margin-top: 10px;">
    <button class="btn-office" onclick="setShelf('Office')">Office</button>
    <button class="btn-living" onclick="setShelf('Living Room')">Living</button>
    <button class="btn-storage" onclick="setShelf('Storage')">Storage</button>
</div>

<script>
    const sheetURL = "https://script.google.com/macros/s/AKfycbyoZySH85-MXYKXySBDGsCg1PyxTp6LpIfptTB4HeLr6D7a__Z1jGrsQ8lVH8UTn0Hn/exec";
    const SCAN_DELAY = 2500;
    
    let codeReader;
    let lastScanTime = 0;
    let lastScan = "";
    let currentShelf = "Office";

    // 1. Wait for page to load
    window.addEventListener('load', function() {
        codeReader = new ZXing.BrowserBarcodeReader();
        console.log("ZXing Ready");
        initCamera();
    });

    function initCamera() {
        const statusEl = document.getElementById('status');
        
        codeReader.listVideoInputDevices()
            .then((videoDevices) => {
                // Find back camera
                const backCam = videoDevices.find(device => /back|rear|environment/i.test(device.label));
                const deviceId = backCam ? backCam.deviceId : videoDevices[0].deviceId;
                
                statusEl.textContent = "Align barcode in the box...";
                
                // 2. Start decoding
                codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
                    if (result) {
                        handleBarcode(result.text);
                    }
                });
            })
            .catch(err => {
                statusEl.textContent = "Error: " + err;
                console.error(err);
            });
    }

    function handleBarcode(isbn) {
        const now = Date.now();
        // Prevent duplicate scans within the delay period
        if (isbn === lastScan && (now - lastScanTime) < SCAN_DELAY) return;

        lastScan = isbn;
        lastScanTime = now;

        // Visual feedback
        document.getElementById('status').textContent = "Scanned: " + isbn;
        document.getElementById('overlay').style.borderColor = "orange";
        
        // Haptic feedback (vibrates on mobile if supported)
        if (navigator.vibrate) navigator.vibrate(100);

        // 3. Send to Google
        const uploadUrl = `${sheetURL}?isbn=${isbn}&shelf=${encodeURIComponent(currentShelf)}`;
        
        fetch(uploadUrl, { mode: 'no-cors' })
            .then(() => {
                document.getElementById('status').textContent = `Saved ${isbn} to ${currentShelf}`;
                setTimeout(() => {
                    document.getElementById('overlay').style.borderColor = "lime";
                }, 1000);
            })
            .catch(err => {
                document.getElementById('status').textContent = "Upload Failed!";
            });
    }

    function setShelf(name) {
        currentShelf = name;
        document.getElementById('status').textContent = "Shelf set to: " + name;
    }
</script>

</body>
</html>
