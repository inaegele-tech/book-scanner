<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/@zxing/library@latest"></script>
</head>

<body>
<h2>Scan Book ISBN</h2>
<video id="video" width="100%" autoplay></video>
<p id="status">Starting camera...</p>

<script>
const codeReader = new ZXing.BrowserBarcodeReader();
const sheetURL = "PASTE_YOUR_WEBAPP_URL_HERE";

let lastScan = "";

async function lookupBook(isbn) {
  const res = await fetch(
    `https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`
  );
  const data = await res.json();

  const book = data["ISBN:"+isbn];
  if (!book) return null;

  return {
    title: book.title || "",
    author: (book.authors||[]).map(a=>a.name).join(", ")
  };
}

codeReader.decodeFromVideoDevice(null, 'video', async (result, err) => {
  if (result) {
    const isbn = result.text;

    if (isbn === lastScan) return;
    lastScan = isbn;

    document.getElementById("status").innerText =
      "Looking up " + isbn;

    const book = await lookupBook(isbn);
    if (!book) return;

    await fetch(sheetURL, {
      method: "POST",
      body: JSON.stringify({
        isbn: isbn,
        title: book.title,
        author: book.author
      })
    });

    navigator.vibrate?.(200);
    document.getElementById("status").innerText =
      "Added: " + book.title;
  }
});
</script>
</body>
</html>
